# UnifiedConfigManager Design Specification

**Date**: October 12, 2025  
**Purpose**: Single source of truth for customer .env configuration operations  
**Consolidates**: customer-config-loader.js + config-persistence.js

---

## Design Goals

1. **Eliminate Duplication**: Single `.env` parsing implementation
2. **Preserve All Functionality**: 100% of existing capabilities
3. **Clean API**: Intuitive methods for load/save/list/display
4. **Backward Compatible**: Works with existing code patterns
5. **Well Tested**: Integration tests for all operations

---

## API Design

### Constructor
```javascript
constructor(options = {})
  - configDir: Base config directory (default: 'config/customers')
  - verbose: Enable verbose logging
```

### Core Methods

#### Loading Operations
```javascript
loadCustomerConfig(customer, environment)
  → Load .env file from config/customers/{customer}/{env}.env
  → Parse into key-value object
  → Return null if not found or is template
  → Uses _parseEnvFile() internally

loadCustomerConfigSafe(customer, environment)
  → Same as loadCustomerConfig but never throws
  → Returns empty object with defaults if not found
  → Always returns an object

parseToStandardFormat(envVars, customer, environment)
  → Convert .env vars to InputCollector-compatible format
  → Standardize field names
  → Return object matching InputCollector output
```

#### Saving Operations
```javascript
saveCustomerConfig(customer, environment, deploymentData)
  → Save deployment configuration to .env file
  → Auto-create customer directory if needed
  → Generate comprehensive .env with sections
  → Uses _generateEnvContent() internally
  → Return saved file path

_generateEnvContent(data)
  → Generate formatted .env file content
  → Includes sections:
    * Core Customer Identity
    * Cloudflare Configuration
    * Service Configuration
    * Domain Configuration
    * Database Configuration
    * Security Configuration
    * URLs and Endpoints
    * Feature Flags
  → Return formatted string
```

#### List/Display Operations
```javascript
listCustomers()
  → Scan config/customers directory
  → Return array of customer names
  → Filter out non-directory entries

displayCustomerConfig(customer, environment)
  → Load and display configuration
  → Format for console output
  → Show all env vars organized by category
```

#### Validation/Utilities
```javascript
isTemplateConfig(envVars)
  → Detect if config is template (has {{ }}) vs real data
  → Check for placeholder account IDs
  → Return boolean

configExists(customer, environment)
  → Check if .env file exists
  → Return boolean

getMissingFields(config, requiredFields)
  → Compare config against required fields
  → Return array of missing field names

mergeConfigs(storedConfig, collectedInputs)
  → Merge loaded config with collected inputs
  → Collected inputs take precedence
  → Return merged object
```

#### Private Methods
```javascript
_parseEnvFile(filePath)
  → Read and parse .env file
  → Handle KEY=VALUE format
  → Handle quoted values
  → Skip comments and empty lines
  → Return key-value object
```

---

## Implementation Details

### .env Parsing Logic (Consolidated)
```javascript
_parseEnvFile(filePath) {
  const content = readFileSync(filePath, 'utf-8');
  const result = {};
  
  content.split('\n').forEach(line => {
    line = line.trim();
    
    // Skip empty lines and comments
    if (!line || line.startsWith('#')) return;
    
    // Parse KEY=VALUE
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
      const key = match[1].trim();
      let value = match[2].trim();
      
      // Remove quotes if present
      if ((value.startsWith('"') && value.endsWith('"')) ||
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1);
      }
      
      result[key] = value;
    }
  });
  
  return result;
}
```

### .env Generation Logic (Consolidated)
```javascript
_generateEnvContent(data) {
  const { customer, environment, coreInputs, confirmations, result } = data;
  const timestamp = new Date().toISOString();
  
  const lines = [
    `# Deployment Configuration - ${customer} (${environment})`,
    `# Last Updated: ${timestamp}`,
    `# Auto-generated by Clodo Framework`,
    '',
    '# ============================================',
    '# Core Customer Identity',
    '# ============================================',
    `CUSTOMER_ID=${customer}`,
    `CUSTOMER_NAME=${customer}`,
    `ENVIRONMENT=${environment}`,
    ''
  ];
  
  // Add sections based on available data
  // ... (full implementation in code)
  
  return lines.join('\n');
}
```

---

## Migration Plan

### Phase 1: Create UnifiedConfigManager
- Implement all methods
- Copy logic from customer-config-loader.js and config-persistence.js
- Consolidate duplicate .env parsing
- Add comprehensive JSDoc comments

### Phase 2: Update References
Find and replace across codebase:
```javascript
// OLD (customer-config-loader):
import { CustomerConfigLoader } from './config/customer-config-loader.js';
const loader = new CustomerConfigLoader();
const config = loader.loadConfig(customer, env);

// NEW (unified):
import { UnifiedConfigManager } from './utils/config/unified-config-manager.js';
const configMgr = new UnifiedConfigManager();
const config = configMgr.loadCustomerConfig(customer, env);

// OLD (config-persistence):
import { ConfigPersistenceManager } from './utils/deployment/config-persistence.js';
const persistence = new ConfigPersistenceManager();
await persistence.saveDeploymentConfig(deployment);

// NEW (unified):
import { UnifiedConfigManager } from './utils/config/unified-config-manager.js';
const configMgr = new UnifiedConfigManager();
await configMgr.saveCustomerConfig(customer, environment, deploymentData);
```

### Phase 3: Test
- Run existing tests
- Verify no regressions
- Test load/save/list operations
- Verify .env parsing works identically

### Phase 4: Clean Up
- Delete customer-config-loader.js
- Delete config-persistence.js (keep as reference until verified)
- Update exports in index files

---

## Files Modified

### New Files
- `src/utils/config/unified-config-manager.js` (NEW)

### Files Updated (to use UnifiedConfigManager)
- Files using CustomerConfigLoader
- Files using ConfigPersistenceManager
- Export statements in index files

### Files Deprecated (after testing)
- `src/config/customer-config-loader.js`
- `src/utils/deployment/config-persistence.js`

---

## Testing Strategy

### Unit Tests
```javascript
describe('UnifiedConfigManager', () => {
  test('loadCustomerConfig - loads existing config')
  test('loadCustomerConfig - returns null for templates')
  test('loadCustomerConfigSafe - never throws')
  test('saveCustomerConfig - creates directory')
  test('saveCustomerConfig - generates valid .env')
  test('listCustomers - returns all customers')
  test('isTemplateConfig - detects templates')
  test('_parseEnvFile - handles quotes')
  test('_parseEnvFile - skips comments')
  test('mergeConfigs - precedence correct')
})
```

### Integration Tests
1. Load real customer config
2. Save deployment config
3. Verify round-trip (save then load)
4. Test with InputCollector integration

---

## Success Criteria

- [ ] All methods implemented
- [ ] .env parsing consolidated (single implementation)
- [ ] All tests passing
- [ ] Zero functionality lost
- [ ] Backward compatible
- [ ] Documentation complete
- [ ] Old files can be deleted safely
