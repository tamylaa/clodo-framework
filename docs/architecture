# System Architecture: How All Pieces Connect

## Current Architecture (v3.1.14)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLI ENTRY POINT                             â”‚
â”‚                   bin/clodo-service.js                          â”‚
â”‚              (73 lines, command registration)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”´â”€â”€â”€â”€â”€â” â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   create   â”‚ â”‚deploy â”‚ â”‚  validate  â”‚  ... (6 commands)
    â”‚ (76 lines) â”‚ â”‚(206)  â”‚ â”‚   (32)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚           â”‚          â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                 â”‚
  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
  â”‚ServiceOrch â”‚  â”‚Manifest  â”‚   â”‚CloudflareAPI
  â”‚estrator    â”‚  â”‚Loader    â”‚   â”‚(Auto-fetch)â”‚
  â”‚(creates)   â”‚  â”‚(detects) â”‚   â”‚            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Current Limitations
- âŒ No unified output handling (each command logs differently)
- âŒ No shared CLI options (--verbose, --json not everywhere)
- âŒ No config file loading in most commands
- âŒ Duplicated validation/error code
- âŒ Inconsistent error messages
- âŒ No progress indicators except in deploy

---

## Target Architecture (After v4.0.0)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLI ENTRY POINT                              â”‚
â”‚                   bin/clodo-service.js                           â”‚
â”‚         (Enhanced with help/version/login registration)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Core Cmds â”‚       â”‚Advanced  â”‚      â”‚Legacy    â”‚
   â”‚(6 cmds)   â”‚       â”‚Commands  â”‚      â”‚Aliases   â”‚
   â”‚           â”‚       â”‚(3 cmds)  â”‚      â”‚(2 cmds)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                â”‚
        All use standardized layer:
          â”‚                 â”‚                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
   â”‚                        â”‚                       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                                 â”‚
   â”‚         STANDARDIZATION LAYER (Phase 1)        â”‚
   â”‚                                                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                                 â”‚
   â”‚  1. StandardOptions         --verbose, --json  â”‚
   â”‚     â€¢ Defines 5 global options                 â”‚
   â”‚     â€¢ Applied to all commands                  â”‚
   â”‚                                                 â”‚
   â”‚  2. OutputFormatter         Unified logging    â”‚
   â”‚     â€¢ 8 methods: success(), error(), etc       â”‚
   â”‚     â€¢ Respects --quiet, --verbose, --json      â”‚
   â”‚     â€¢ All commands use this                    â”‚
   â”‚                                                 â”‚
   â”‚  3. ProgressManager         Visual feedback    â”‚
   â”‚     â€¢ Spinners, step progress, bars            â”‚
   â”‚     â€¢ Used in deploy, create, validate         â”‚
   â”‚                                                 â”‚
   â”‚  4. ConfigLoader            --config-file      â”‚
   â”‚     â€¢ Load defaults from JSON                  â”‚
   â”‚     â€¢ Merge with CLI options                   â”‚
   â”‚     â€¢ All commands support this                â”‚
   â”‚                                                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                 â”‚
   â”‚      FEATURE PARITY LAYER (Phase 2)            â”‚
   â”‚                                                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                                 â”‚
   â”‚  5. Shared Utilities        DRY Principle      â”‚
   â”‚     â€¢ validation-helpers.js (validateToken)    â”‚
   â”‚     â€¢ error-helpers.js (handleServiceNotFound) â”‚
   â”‚     â€¢ service-helpers.js (loadService)         â”‚
   â”‚     â€¢ Exit codes & error messages              â”‚
   â”‚     â€¢ All commands import from shared/         â”‚
   â”‚                                                 â”‚
   â”‚  6. Consistent Error Handling                  â”‚
   â”‚     â€¢ Exit codes: SUCCESS(0) to UNKNOWN(99)    â”‚
   â”‚     â€¢ Error messages: catalog system           â”‚
   â”‚     â€¢ Context in all error reports             â”‚
   â”‚                                                 â”‚
   â”‚  7. Feature Parity                             â”‚
   â”‚     â€¢ All commands: --verbose, --quiet, --json â”‚
   â”‚     â€¢ All commands: config file support        â”‚
   â”‚     â€¢ All commands: proper exit codes          â”‚
   â”‚     â€¢ Optional features: preview, dry-run      â”‚
   â”‚                                                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                 â”‚
   â”‚      SERVICE ORCHESTRATION LAYER              â”‚
   â”‚                                                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                                 â”‚
   â”‚  Core Orchestrators                            â”‚
   â”‚  â€¢ ServiceOrchestrator (create, validate)      â”‚
   â”‚  â€¢ ManifestLoader (detects service type)       â”‚
   â”‚  â€¢ CloudflareAPI (auto-fetch credentials)      â”‚
   â”‚  â€¢ CloudflareServiceValidator                  â”‚
   â”‚                                                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: How It All Connects

### Example: Deploy Command Flow

```
User Input
    â†“
npx clodo-service deploy --verbose --json --domain example.com
    â”‚
    â”œâ”€ Parse with StandardOptions
    â”‚  â”œâ”€ --verbose â†’ OutputFormatter.verbose = true
    â”‚  â”œâ”€ --json    â†’ OutputFormatter.json = true
    â”‚  â””â”€ --domain  â†’ deployOptions.domain = 'example.com'
    â”‚
    â”œâ”€ Load defaults from ConfigLoader (if --config-file specified)
    â”‚
    â”œâ”€ Start credential collection with ProgressManager
    â”‚  â”œâ”€ Spinner: "Validating token..."
    â”‚  â”œâ”€ DeploymentCredentialCollector.collectCredentials()
    â”‚  â”‚  â”œâ”€ Prompt for token (or use flag/env)
    â”‚  â”‚  â”œâ”€ Validate with CloudflareAPI
    â”‚  â”‚  â”œâ”€ Auto-fetch account ID (if needed)
    â”‚  â”‚  â””â”€ Auto-fetch zone ID (if needed)
    â”‚  â””â”€ Spinner: "âœ“ Credentials validated"
    â”‚
    â”œâ”€ Detect service with ManifestLoader
    â”‚  â”œâ”€ Load clodo.manifest.json (if Clodo service)
    â”‚  â”œâ”€ Extract serviceName, serviceType, domain
    â”‚  â””â”€ Override domain if --domain flag provided
    â”‚
    â”œâ”€ Validate service with CloudflareServiceValidator
    â”‚
    â”œâ”€ Build deployment context
    â”‚
    â”œâ”€ Output results with OutputFormatter
    â”‚  â”œâ”€ If --json: output valid JSON object
    â”‚  â”œâ”€ If --verbose: include debug details
    â”‚  â”œâ”€ If --quiet: only show errors/warnings
    â”‚  â””â”€ Use error-messages catalog for consistency
    â”‚
    â””â”€ Exit with proper code
       â”œâ”€ 0 = SUCCESS
       â”œâ”€ 3 = INVALID_CONFIG
       â”œâ”€ 4 = CREDENTIAL_ERROR
       â””â”€ 99 = UNKNOWN
```

### Connections in Service.yaml

```
Manifest File (clodo.manifest.json / wrangler.toml)
         â”‚
         â”œâ”€ read by ManifestLoader
         â”‚     â”œâ”€ Extract: serviceName
         â”‚     â”œâ”€ Extract: serviceType
         â”‚     â”œâ”€ Extract: domain
         â”‚     â””â”€ Detect: Is this Clodo or Cloudflare?
         â”‚
         â”œâ”€ used by deploy.js
         â”‚     â”œâ”€ Know what service to deploy
         â”‚     â”œâ”€ Know where to deploy
         â”‚     â””â”€ Know what type of service
         â”‚
         â”œâ”€ used by validate.js
         â”‚     â”œâ”€ Check for required fields
         â”‚     â”œâ”€ Validate field formats
         â”‚     â””â”€ Report issues via OutputFormatter
         â”‚
         â””â”€ used by update.js
               â”œâ”€ Load current config
               â”œâ”€ Merge with user changes
               â”œâ”€ Validate before saving
               â””â”€ Use ProgressManager to show progress
```

---

## Shared Utilities Dependency Map

```
StandardOptions (Phase 1.1)
    â†“
    Used by: all 6 commands + new commands
    Defines: --verbose, --quiet, --json, --no-color, --config-file

OutputFormatter (Phase 1.2)
    â†‘ depends on StandardOptions
    â†“
    Used by: all 6 commands + new commands
    Methods: success(), error(), warning(), info(), section(), list(), table(), progress()

ProgressManager (Phase 1.3)
    â†‘ depends on StandardOptions
    â†“
    Used by: deploy, create, validate, diagnose
    Methods: startSpinner(), updateSpinner(), stopSpinner(), step(), progress()

ConfigLoader (Phase 1.4)
    â†‘ depends on StandardOptions
    â†“
    Used by: all 6 commands + new commands
    Methods: loadConfig(), validateConfigFile(), mergeConfigWithOptions()

ExitCodes (Phase 2.2)
    â†“
    Used by: all 6 commands + helpers
    Defines: SUCCESS(0), MISSING_ARGS(2), INVALID_CONFIG(3), CREDENTIAL_ERROR(4)

ErrorMessages (Phase 2.2)
    â†‘ depends on ExitCodes
    â†“
    Used by: all commands + error-helpers
    Format: Consistent "Invalid {field}: {value}. Expected: {format}"

ValidationHelpers (Phase 2.1)
    â†‘ depends on ErrorMessages, ExitCodes
    â†“
    Used by: deploy, create, update, validate
    Methods: validateToken(), validateDomain(), validatePath()

ErrorHelpers (Phase 2.1)
    â†‘ depends on ExitCodes, ErrorMessages
    â†“
    Used by: all commands
    Methods: handleServiceNotFound(), handleInvalidConfig(), handleCredentialError()

ServiceHelpers (Phase 2.1)
    â†‘ depends on ValidationHelpers, ErrorHelpers
    â†“
    Used by: all commands
    Methods: loadService(), detectServiceType(), buildServiceContext()

Logger (Phase 4.2)
    â†‘ depends on OutputFormatter
    â†“
    Used by: all commands
    Methods: debug(), info(), warn(), error()
    Features: file logging, log levels, timestamps
```

---

## How Each Command Uses the Layers

### Create Command Flow
```
User: npx clodo-service create --config-file my-config.json --json

1. StandardOptions
   â””â”€ Parse --config-file, --json

2. ConfigLoader
   â””â”€ Load defaults from my-config.json

3. ServiceOrchestrator
   â””â”€ Collect 88 fields (three-tier input: flags â†’ env â†’ prompts)

4. ProgressManager
   â””â”€ Show step progress: "1/5 Collecting inputs"

5. ServiceCreator
   â””â”€ Generate service files

6. OutputFormatter
   â””â”€ Output success as JSON if --json specified
   â””â”€ Use error-messages catalog for any issues

7. ExitCodes
   â””â”€ Exit with 0 (SUCCESS) or 1 (error)
```

### Deploy Command Flow
```
User: npx clodo-service deploy --verbose --domain prod.com --dry-run

1. StandardOptions
   â””â”€ Parse --verbose, --domain, --dry-run

2. ProgressManager
   â””â”€ Show spinner: "Validating credentials..."

3. DeploymentCredentialCollector
   â””â”€ Collect token, auto-fetch account/zone IDs
   â””â”€ Cache via ApiTokenManager

4. ManifestLoader
   â””â”€ Load service config
   â””â”€ Extract serviceName, serviceType

5. ValidationHelpers + CloudflareServiceValidator
   â””â”€ Validate service + credentials

6. ProgressManager
   â””â”€ Show step: "2/3 Preparing deployment"

7. Deployment Engine
   â””â”€ Perform (or dry-run) deployment

8. OutputFormatter
   â””â”€ If --verbose: show all deployment details
   â””â”€ If --dry-run: show what WOULD have happened
   â””â”€ Include timing, resource info, etc

9. ExitCodes
   â””â”€ Exit with code based on result
```

### Validate Command Flow
```
User: npx clodo-service validate ./my-service --export-report report.json

1. StandardOptions
   â””â”€ Parse --export-report

2. ConfigLoader
   â””â”€ Load validation rules (if from config file)

3. ServiceOrchestrator
   â””â”€ Validate service structure

4. ValidationHelpers
   â””â”€ Validate each field format

5. CloudflareServiceValidator
   â””â”€ Check Cloudflare-specific requirements

6. ProgressManager
   â””â”€ Show spinner: "Validating configuration..."

7. OutputFormatter
   â””â”€ List issues with colors (errors in red, warnings in yellow)
   â””â”€ Export JSON report if --export-report

8. ExitCodes
   â””â”€ Exit with 0 (valid) or 8 (VALIDATION_ERROR)
```

---

## Example Integration: New Feature "Dry-Run Everywhere"

**Goal**: Add --dry-run to validate, update, and diagnose (already in deploy)

### Implementation Plan

1. Add to StandardOptions (Phase 1.1)
   ```javascript
   options.push({
     name: '--dry-run',
     description: 'Simulate action without making changes',
     applies: ['deploy', 'update', 'diagnose']
   })
   ```

2. Update validate.js
   ```javascript
   if (options.dryRun) {
     formatter.info('Running in dry-run mode - no changes will be made')
     // Load service but don't modify anything
     // Report what WOULD be changed
   }
   ```

3. Update update.js
   ```javascript
   if (options.dryRun) {
     formatter.info('Preview mode: changes will NOT be applied')
     // Show what would be updated
     formatter.list(proposedChanges, 'Proposed Changes')
   }
   ```

4. Update diagnose.js
   ```javascript
   if (options.dryRun) {
     formatter.info('Dry-run: showing diagnosis without fixes')
     // Report issues without attempting repairs
   }
   ```

5. Create test: test/scenarios/dry-run-all-commands.test.js
   ```javascript
   describe('Dry-run feature parity', () => {
     it('validate --dry-run shows what would be checked')
     it('update --dry-run shows what would be changed')
     it('diagnose --dry-run shows what would be fixed')
   })
   ```

### Result
- âœ… Feature consistent across 4 commands
- âœ… Users can preview changes before committing
- âœ… No duplicated code (logic in helpers)
- âœ… Documented in CLI_OPTIONS_GUIDE.md
- âœ… Version bump: v3.3.2

---

## Quality Assurance: Testing the Connections

### Test Strategy

```
Unit Tests (Level 1)
â”œâ”€ StandardOptions: parse options correctly
â”œâ”€ OutputFormatter: format output correctly
â”œâ”€ ProgressManager: show spinners correctly
â”œâ”€ ConfigLoader: load/merge configs correctly
â””â”€ All shared helpers: work independently

Integration Tests (Level 2)
â”œâ”€ create.js uses StandardOptions + OutputFormatter
â”œâ”€ deploy.js uses ProgressManager + ConfigLoader
â”œâ”€ validate.js uses ValidationHelpers + ErrorHelpers
â”œâ”€ update.js uses ConfigLoader + ProgressManager
â”œâ”€ diagnose.js uses ProgressManager + ExitCodes
â””â”€ assess.js uses OutputFormatter + ExitCodes

Scenario Tests (Level 3)
â”œâ”€ create â†’ validate â†’ deploy workflow
â”œâ”€ update â†’ diagnose â†’ fix workflow
â”œâ”€ deploy with auto-fetch workflow
â””â”€ config-file override workflow

Coverage Goals
â”œâ”€ Phase 1: >80% coverage on new files
â”œâ”€ Phase 2: >85% coverage on modified commands
â”œâ”€ Phase 3: >90% coverage overall
â””â”€ Phase 4: Maintain >90% coverage
```

---

## Troubleshooting: How to Debug Issues

### Issue: Command shows duplicate messages
**Root Cause**: OutputFormatter not being used everywhere
**Fix**: Search `console.log` in all commands, replace with `formatter.info()`

### Issue: Different error messages for same error
**Root Cause**: Not using error-messages catalog
**Fix**: Add error to catalog, import from error-messages.js

### Issue: --json output not parseable
**Root Cause**: OutputFormatter not removing colors/spinners in JSON mode
**Fix**: Check OutputFormatter.json flag, suppress formatting

### Issue: Config file options not overriding CLI options
**Root Cause**: Wrong merge order in mergeConfigWithOptions()
**Fix**: CLI options should override config file (priority: CLI > config > env)

### Issue: Progress spinners appearing in tests
**Root Cause**: ProgressManager always showing spinners
**Fix**: Detect test environment, suppress output during testing

---

## Performance Targets

```
Command Startup Time
â”œâ”€ create:   <2 seconds (before prompting)
â”œâ”€ deploy:   <2 seconds (before credential collection)
â”œâ”€ validate: <1 second
â”œâ”€ update:   <1 second
â”œâ”€ diagnose: <1 second
â””â”€ assess:   <1 second

Memory Usage
â”œâ”€ Base:     <20 MB
â”œâ”€ With all options: <50 MB
â””â”€ During processing: <100 MB

Test Execution
â”œâ”€ Unit tests:        <5 seconds
â”œâ”€ Integration tests: <15 seconds
â”œâ”€ Scenario tests:    <10 seconds
â””â”€ Full suite:        <30 seconds
```

---

## Success: How to Know Everything Is Connected

1. âœ… **Code Duplication**: `grep -r "validateToken" bin/commands/` returns â‰¤1 result
2. âœ… **Consistent Output**: Run all 6 commands with `--json`, all produce valid JSON
3. âœ… **Error Consistency**: All errors use EXIT_CODES and error-messages
4. âœ… **Test Coverage**: `npm test -- --coverage` shows >90% overall
5. âœ… **Feature Parity**: Each command has same standard options
6. âœ… **Performance**: All commands start in <2 seconds
7. âœ… **Backward Compat**: Old command names still work
8. âœ… **Documentation**: CLI_OPTIONS_GUIDE.md lists all options once

---

**This architecture ensures**:
- ðŸŽ¯ No duplicated code (DRY principle)
- ðŸŽ¯ Consistent user experience (all commands feel the same)
- ðŸŽ¯ Easy to maintain (changes in one place affect all)
- ðŸŽ¯ Easy to extend (new commands follow same pattern)
- ðŸŽ¯ Easy to test (shared code is unit tested once)
- ðŸŽ¯ Professional quality (proper error handling, logging, output)

