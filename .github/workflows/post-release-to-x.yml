name: Post release to X

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'If true, only validate token via GET /2/users/me (no post)'
        required: false
        default: 'true'

permissions:
  contents: read

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - name: Dry-check token (manual dispatch)
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.dry_run == 'true')
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$X_BEARER_TOKEN" ]; then
            echo "‚ö†Ô∏è X_BEARER_TOKEN secret not set; failing dry-check"
            exit 1
          fi
          echo "üîí X_BEARER_TOKEN present; calling GET /2/users/me"
          HTTP_STATUS=$(curl -s -o /tmp/x_response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${X_BEARER_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.twitter.com/2/users/me")
          echo "HTTP status: $HTTP_STATUS"
          jq . /tmp/x_response.json || true
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Token valid (dry-check)"
            exit 0
          else
            echo "‚ùå Token check failed (dry-run)"
            exit 1
          fi

      - name: Post announcement to X
        if: github.event_name != 'workflow_dispatch' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          set -euo pipefail
          if [ -z "$X_BEARER_TOKEN" ]; then
            echo "‚ö†Ô∏è X_BEARER_TOKEN secret not set; skipping post"
            exit 0
          fi
          MESSAGE="v${RELEASE_TAG} ‚Äî Programmatic createService now normalizes legacy kv ‚Üí upstash, accepts plural durableObjects, and emits Durable Object bindings into generated middleware. Read the release notes: ${RELEASE_URL}"
          PAYLOAD=$(jq -nc --arg txt "$MESSAGE" '{text: $txt}')
          echo "Posting to X: $MESSAGE"
          HTTP_RESPONSE=$(curl -s -o /tmp/x_post_response.json -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${X_BEARER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "https://api.twitter.com/2/tweets")
          echo "HTTP status: $HTTP_RESPONSE"
          cat /tmp/x_post_response.json
