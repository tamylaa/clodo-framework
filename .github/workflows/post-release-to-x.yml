name: Post release to X

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - name: Post announcement to X
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          set -euo pipefail
          if [ -z "$X_BEARER_TOKEN" ]; then
            echo "⚠️ X_BEARER_TOKEN secret not set; skipping post"
            exit 0
          fi
          MESSAGE="v${RELEASE_TAG} — Programmatic createService now normalizes legacy kv → upstash, accepts plural durableObjects, and emits Durable Object bindings into generated middleware. Read the release notes: ${RELEASE_URL}"
          PAYLOAD=$(jq -nc --arg txt "$MESSAGE" '{text: $txt}')
          echo "Posting to X: $MESSAGE"
          HTTP_RESPONSE=$(curl -s -o /tmp/x_post_response.json -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${X_BEARER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "https://api.twitter.com/2/tweets")
          echo "HTTP status: $HTTP_RESPONSE"
          cat /tmp/x_post_response.json
