import { BaseGenerator } from '../BaseGenerator.js';
import { join } from 'path';
import { writeFileSync } from 'fs';

/**
 * README Generator
 * Generates comprehensive README.md documentation for services
 */
export class ReadmeGenerator extends BaseGenerator {
  /**
   * Generate README.md
   * @param {Object} context - Generation context
   * @returns {Promise<string>} Path to generated README file
   */
  async generate(context) {
    const { coreInputs, confirmedValues, servicePath } = this.extractContext(context);
    
    if (!this.shouldGenerate(context)) {
      return null;
    }

    const readmeContent = this._generateReadmeContent(coreInputs, confirmedValues);
    
    const filePath = join(servicePath, 'README.md');
    writeFileSync(filePath, readmeContent, 'utf8');
    return filePath;
  }

  /**
   * Generate README content
   * @private
   */
  _generateReadmeContent(coreInputs, confirmedValues) {
    return `# ${confirmedValues.displayName}

${confirmedValues.description}

## ğŸš€ Quick Start

\\\`\\\`\\\`bash
# Setup development environment
.\\\\scripts\\\\setup.ps1

# Start development server
npm run dev

# Run tests
npm test

# Deploy to production
.\\\\scripts\\\\deploy.ps1 -Environment production
\\\`\\\`\\\`

## ğŸ“‹ Features

${Object.entries(confirmedValues.features)
  .filter(([, enabled]) => enabled)
  .map(([feature]) => `- âœ… ${feature.replace(/([A-Z])/g, ' $1').toLowerCase()}`)
  .join('\n')}

## ğŸ—ï¸ Architecture

This service is built with the **Clodo Framework** and follows a three-tier architecture:

1. **Input Collection**: Collects and validates service requirements
2. **Smart Confirmations**: Generates and confirms derived configuration values
3. **Automated Generation**: Creates all necessary configuration files and components

## ğŸ“ Project Structure

\`\`\`
${coreInputs.serviceName}/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ domains.js          # Domain configuration
â”‚   â”œâ”€â”€ worker/
â”‚   â”‚   â””â”€â”€ index.js            # Cloudflare Worker entry point
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ service-handlers.js # Request handlers
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ service-middleware.js # Request/response middleware
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ service-schema.js   # Data validation schemas
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ service-utils.js    # Utility functions
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy.ps1              # Deployment script
â”‚   â”œâ”€â”€ setup.ps1               # Environment setup
â”‚   â””â”€â”€ health-check.ps1        # Health monitoring
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ unit/                   # Unit tests
â”‚   â””â”€â”€ integration/            # Integration tests
â”œâ”€â”€ config/                     # Environment configurations
â”œâ”€â”€ docs/                       # Documentation
â””â”€â”€ wrangler.toml               # Cloudflare Workers config
\`\`\`

## ğŸ”§ Configuration

### Environment Variables

Copy \`.env.example\` to \`.env\` and configure:

\`\`\`bash
# Cloudflare Configuration
CLOUDFLARE_ACCOUNT_ID=your_account_id
CLOUDFLARE_ZONE_ID=your_zone_id
CLOUDFLARE_API_TOKEN=your_api_token

# Service Configuration
SERVICE_NAME=${coreInputs.serviceName}
SERVICE_TYPE=${coreInputs.serviceType}
DOMAIN_NAME=${coreInputs.domainName}
ENVIRONMENT=${coreInputs.environment}
\`\`\`

### Service URLs

- **Production**: ${confirmedValues.productionUrl}
- **Staging**: ${confirmedValues.stagingUrl}
- **Development**: ${confirmedValues.developmentUrl}
- **Documentation**: ${confirmedValues.documentationUrl}

## ğŸ§ª Testing

\`\`\`bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run integration tests only
npm test -- --testPathPattern=integration
\`\`\`

## ğŸš€ Deployment

### Development

\`\`\`bash
npm run dev
\`\`\`

### Staging

\`\`\`bash
.\\scripts\\deploy.ps1 -Environment staging
\`\`\`

### Production

\`\`\`bash
.\\scripts\\deploy.ps1 -Environment production
\`\`\`

## ğŸ¥ Health Checks

\`\`\`bash
# Check service health
.\\scripts\\health-check.ps1 -Environment production
\`\`\`

Health check endpoint: \`${confirmedValues.healthCheckPath}\`

## ğŸ“š API Documentation

API Base Path: \`${confirmedValues.apiBasePath}\`

See [API Documentation](./docs/API.md) for detailed endpoint information.

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## ğŸ“„ License

${confirmedValues.author} - Generated by Clodo Framework v3.0.0

## ğŸ”— Links

- **Repository**: ${confirmedValues.gitRepositoryUrl}
- **Documentation**: ${confirmedValues.documentationUrl}
- **Health Check**: ${confirmedValues.productionUrl}${confirmedValues.healthCheckPath}
`;
  }

  /**
   * Determine if generator should run
   */
  shouldGenerate(context) {
    return true; // Always generate README
  }
}
