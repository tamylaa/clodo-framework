import { BaseGenerator } from '../BaseGenerator.js';
import { join } from 'path';

/**
 * StagingEnvGenerator
 * 
 * Generates config/staging.env file for staging environment.
 */
export class StagingEnvGenerator extends BaseGenerator {
  constructor(options = {}) {
    super({
      name: 'StagingEnvGenerator',
      description: 'Generates staging environment configuration',
      outputPath: 'config/staging.env',
      ...options
    });
  }

  shouldGenerate(context) {
    return true;
  }

  async generate(context) {
    const coreInputs = context.coreInputs || context;
    const confirmedValues = context.confirmedValues || context;
    const servicePath = context.servicePath || context.outputDir;

    this.setContext({ coreInputs, confirmedValues, servicePath });

    const content = `# Staging Environment Configuration
# Generated by Clodo Framework GenerationEngine

# Service Configuration
SERVICE_NAME=${coreInputs.serviceName}
SERVICE_TYPE=${coreInputs.serviceType}
ENVIRONMENT=staging

# URLs
PRODUCTION_URL=${confirmedValues.productionUrl}
STAGING_URL=${confirmedValues.stagingUrl}
DEVELOPMENT_URL=${confirmedValues.developmentUrl}

# Cloudflare Configuration
CLOUDFLARE_ACCOUNT_ID=${coreInputs.cloudflareAccountId}
CLOUDFLARE_ZONE_ID=${coreInputs.cloudflareZoneId}

# Database
DATABASE_NAME=${confirmedValues.databaseName}

# Logging and Monitoring
LOG_LEVEL=info
METRICS_ENABLED=true
ERROR_REPORTING_ENABLED=true
`;

    await this.writeFile(join('config', 'staging.env'), content);
    return join(servicePath, 'config', 'staging.env');
  }

  validateContext(context) {
    const coreInputs = context.coreInputs || context;
    const confirmedValues = context.confirmedValues || context;

    const required = [
      { field: 'serviceName', source: coreInputs },
      { field: 'serviceType', source: coreInputs },
      { field: 'cloudflareAccountId', source: coreInputs },
      { field: 'cloudflareZoneId', source: coreInputs },
      { field: 'productionUrl', source: confirmedValues },
      { field: 'stagingUrl', source: confirmedValues },
      { field: 'developmentUrl', source: confirmedValues },
      { field: 'databaseName', source: confirmedValues }
    ];

    const missing = required
      .filter(({ field, source }) => !source || !source[field])
      .map(({ field }) => field);

    if (missing.length > 0) {
      throw new Error(
        `StagingEnvGenerator: Missing required fields: ${missing.join(', ')}`
      );
    }

    return true;
  }
}
